<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byte Sena Hub - Set New Password</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    
    <style>
        /* Reusing styles from login.html */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: 'Orbitron', sans-serif; background-color: #020a14; color: #e0e0e0;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .background-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .background-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px; z-index: 1;
        }
        /* Styles for logo, falling words, etc. would go here if needed */

        .form-container { /* Renamed from login-container */
            width: 400px; padding: 40px; position: relative; overflow: hidden; border-radius: 10px; z-index: 4;
        }
        @keyframes rotating { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .form-container::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(transparent, transparent, transparent, #00c6ff);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.3); border-radius: 20px;
            animation: rotating 4s linear infinite; animation-delay: -1s;
        }
        .form-container::after {
            content: ""; position: absolute; inset: 4px; background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px;
        }
        .content-wrapper { position: relative; z-index: 10; }
        .logo { text-align: center; font-size: 2.5rem; font-weight: 700; margin-bottom: 30px; color: #fff; text-shadow: 0 0 5px #00c6ff, 0 0 10px #00c6ff, 0 0 20px #00c6ff, 0 0 40px #00c6ff; }
        .input-group { position: relative; margin-bottom: 30px; }
        .input-field { width: 100%; padding: 10px 0; font-family: 'Orbitron', sans-serif; font-size: 1rem; color: #fff; background: transparent; border: none; border-bottom: 2px solid rgba(0, 255, 255, 0.5); outline: none; transition: border-color 0.3s; }
        .input-label { position: absolute; top: 10px; left: 0; color: rgba(255, 255, 255, 0.7); font-size: 1rem; pointer-events: none; transition: 0.3s ease-out; }
        .input-field:focus + .input-label, .input-field:valid + .input-label { top: -15px; font-size: 0.8rem; color: #00c6ff; }
        .input-field:focus { border-bottom-color: #00c6ff; box-shadow: 0 5px 15px -10px rgba(0, 255, 255, 0.5); }
        .submit-btn { /* Renamed from login-btn */
            width: 100%; padding: 12px; border: none; border-radius: 5px; background-color: #00c6ff; color: #020a14;
            font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: box-shadow 0.3s, background-color 0.3s;
        }
        .submit-btn:hover:enabled { background-color: #1afaff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); }
        .submit-btn:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }

        .links { text-align: center; margin-top: 20px; }
        .links a { color: #00c6ff; text-decoration: none; font-size: 0.9rem; transition: color 0.3s; }
        .links a:hover { color: #fff; text-decoration: underline; }
        #message-box { text-align: center; padding: 10px; margin-top: 20px; border-radius: 5px; display: none; font-size: 0.9rem; font-weight: 600; }
        .message-success { background-color: rgba(0, 255, 255, 0.1); color: #00c6ff; border: 1px solid #00c6ff; }
        .message-error { background-color: rgba(255, 0, 100, 0.1); color: #ff0064; border: 1px solid #ff0064; }
    </style>
</head>
<body>
    
    <div class="background-container">
        <!-- Background elements (logo, falling words) can be added here if desired -->
    </div>

    <main class="form-container">
        <div class="content-wrapper">
            <h1 class="logo">Set New Password</h1>
            
            <form id="reset-password-form">
                <div class="input-group">
                    <input type="password" id="password" class="input-field" required>
                    <label for="password" class="input-label">New Password</label>
                </div>
                 <div class="input-group">
                    <input type="password" id="confirm-password" class="input-field" required>
                    <label for="confirm-password" class="input-label">Confirm New Password</label>
                </div>
                
                <button type="submit" class="submit-btn">
                    Update Password
                </button>
            </form>
            
            <div id="message-box"></div>

            <div class="links">
                <!-- CORRECTED LINK -->
                <a href="index.html">Back to Login</a>
            </div>
        </div>
    </main>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Config ---
        const supabaseUrl = 'https://xidmunqlvafekyvmmbaf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpZG11bnFsdmFmZWt5dm1tYmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjI3ODEsImV4cCI6MjA3NjYzODc4MX0.Lbzzj4G-Wqf9_I34lacmo9RB6q5WizucuP12T0KdUh8';

        if (supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY') {
             document.body.innerHTML = '<h1 style="color: red;">Supabase not configured.</h1>';
            throw new Error("Supabase credentials not set.");
        }
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // --- DOM Elements ---
        const form = document.getElementById('reset-password-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const messageBox = document.getElementById('message-box');
        const submitButton = form.querySelector('.submit-btn');

        let hasHandledAuthEvent = false; // Flag to prevent double execution

        // --- Handle Password Recovery Event ---
        // Supabase sends an event when the user arrives via the recovery link
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY' && !hasHandledAuthEvent) {
                hasHandledAuthEvent = true; // Set flag
                console.log("Password recovery event received. Session:", session);
                 showMessage('Please enter and confirm your new password.', 'success'); 
            } else if (event === 'SIGNED_IN' && !hasHandledAuthEvent) {
                 window.location.href = 'dashboard.html';
             } else if (event === 'SIGNED_OUT' && !hasHandledAuthEvent) {
                 console.warn("Not in password recovery state. Redirecting to login.");
             }
        });

        // --- Handle Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (password !== confirmPassword) {
                showMessage('Passwords do not match.', 'error');
                return;
            }
            if (!password) {
                 showMessage('Password cannot be empty.', 'error');
                 return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';
            showMessage('', 'success'); // Clear previous messages

            try {
                // Use Supabase client to update the user's password
                const { error } = await supabase.auth.updateUser({
                    password: password 
                });

                if (error) throw error;

                showMessage('Password updated successfully! Redirecting to login...', 'success');
                // Optional: Sign out the user from the recovery session
                await supabase.auth.signOut(); 
                
                setTimeout(() => {
                    // Redirect to the new main login page
                    window.location.href = 'index.html'; 
                }, 2000);

            } catch (error) {
                console.error('Error updating password:', error);
                showMessage(error.message || 'Failed to update password. Please try the recovery link again.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Password';
            }
        });

        // --- Utility ---
         function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = type === 'success' ? 'message-success' : 'message-error'; 
            messageBox.style.opacity = '1'; 
            messageBox.style.display = 'block';
        }
        
        // Input label float effect
         document.querySelectorAll('.input-field').forEach(input => {
            if (input.value) input.classList.add('valid');
            input.addEventListener('blur', () => {
                if (input.value) input.classList.add('valid');
                else input.classList.remove('valid');
            });
        });

    </script>

</body>
</html>